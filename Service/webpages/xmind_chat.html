<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>xMind Chat Page</title>
    <!-- Include Showdown.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            background-color: #f4f4f4;
        }

        /* Left panel styles */
        #left-panel {
            width: 300px;
            background-color: #2c3e50;
            color: white;
            overflow-y: auto;
            padding-top: 20px;
            height: 100vh; /* Fill the viewport height */
        }

        #session-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

            #session-list li {
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                position: relative;
            }

                #session-list li:hover {
                    background-color: #34495e;
                }

                #session-list li small {
                    font-size: 12px;
                    color: #ecf0f1;
                }

                #session-list li strong {
                    font-size: 14px;
                    color: #bdc3c7;
                }

        /* Remove button styles */
        .remove-session-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

            .remove-session-btn:hover {
                color: red;
            }

        /* Main content styles */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* Prevent main content scroll */
        }

        #chat-container {
            width: 100%;
            max-width: 800px;
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent chat container scroll */
        }

        /* Top area for model selection */
        #top-area {
            padding: 20px;
            border-bottom: 1px solid #ddd;
        }

        #model-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Middle area for chat history */
        #history {
            flex: 1;
            list-style-type: none;
            padding: 20px;
            margin: 0;
            overflow-y: auto; /* Enable scrolling */
        }

            #history li {
                padding: 10px;
                border-bottom: 1px solid #ddd;
            }

                #history li:nth-child(even) {
                    background-color: #f9f9f9;
                }

        /* Bottom area for input */
        #bottom-area {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        /* Status message styles */
        #status-message {
            margin-bottom: 10px;
            font-size: 14px;
            color: #555;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Spinner styles */
        .spinner {
            margin-left: 10px;
            border: 4px solid #f3f3f3; /* Light gray */
            border-top: 4px solid #007BFF; /* Blue */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #prompt-input-area {
            display: flex;
            align-items: center;
        }

        #prompt-input {
            flex: 1;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #send-btn {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            #send-btn:hover {
                background-color: #0056b3;
            }

            #send-btn:disabled {
                background-color: #999;
                cursor: not-allowed;
            }

        /* Styles for rendered content */
        .rendered-content {
            width: 100%;
            overflow: auto;
        }

            .rendered-content iframe {
                width: 100%;
                height: 300px;
                border: none;
            }

            .rendered-content pre {
                background-color: #f0f0f0;
                padding: 10px;
                overflow: auto;
            }

            .rendered-content div {
                margin-bottom: 10px;
            }

        /* Timestamp styles */
        .message-timestamp {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        /* Differentiate user and AI messages */
        .user-message {
            text-align: right;
        }

        .ai-message {
            text-align: left;
        }
    </style>
</head>
<body>

    <!-- Left Panel -->
    <div id="left-panel">
        <ul id="session-list">
            <!-- Session IDs will be populated here -->
        </ul>
    </div>

    <!-- Main Content Area -->
    <div id="main-content">
        <div id="chat-container">
            <!-- Top Area for Model Selection -->
            <div id="top-area">
                <select id="model-select"></select>
            </div>

            <!-- Middle Area for Chat History -->
            <ul id="history">
                <!-- Chat history will appear here -->
            </ul>

            <!-- Bottom Area for Input and Status -->
            <div id="bottom-area">
                <!-- Status Message -->
                <div id="status-message" style="display: none;">
                    Agent is working...
                    <div class="spinner"></div>
                </div>

                <!-- Prompt Input Area -->
                <div id="prompt-input-area">
                    <input type="text" id="prompt-input" placeholder="Enter your prompt here...">
                    <button id="send-btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sessionId = "";

        // Get the base URL from the page's location
        const baseUrl = `${window.location.protocol}//${window.location.hostname}:${window.location.port}`;

        // Fetch available models
        function fetchModels() {
            fetch(`${baseUrl}/api/rootagents`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer NO_KEY`
                }
            })
                .then(response => response.json())
                .then(data => {
                    const modelSelect = document.getElementById('model-select');
                    modelSelect.innerHTML = ''; // Clear existing options
                    data.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching models:', error);
                    alert('An error occurred while fetching the models!');
                });
        }

        // Create a session list item
        function createSessionListItem(session) {
            const listItem = document.createElement('li');
            const formattedTime = new Date(session.time).toLocaleString();

            // Create small element to hold time and remove button
            const timeRow = document.createElement('small');
            timeRow.textContent = formattedTime + ' ';

            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.classList.add('remove-session-btn');
            removeBtn.textContent = 'ðŸ—‘ï¸'; // Use trash can emoji or any symbol

            // Add event listener to remove button
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent the click from triggering the list item click event
                removeSession(session.id, listItem);
            });

            // Append remove button to timeRow
            timeRow.appendChild(removeBtn);

            // Create the strong element for session id
            const idRow = document.createElement('strong');
            idRow.textContent = session.id;

            // Append timeRow and idRow to listItem
            listItem.appendChild(timeRow);
            listItem.appendChild(document.createElement('br'));
            listItem.appendChild(idRow);

            listItem.dataset.sessionId = session.id;
            listItem.addEventListener('click', () => {
                sessionId = session.id;
                fetchChatHistory(sessionId);
            });

            return listItem;
        }

        // Fetch session list and populate the left panel
        function fetchSessionList() {
            fetch(`${baseUrl}/api/sessionlist`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer NO_KEY`
                }
            })
                .then(response => response.json())
                .then(data => {
                    const sessionList = document.getElementById('session-list');
                    sessionList.innerHTML = ''; // Clear existing sessions
                    data.forEach(session => {
                        const listItem = createSessionListItem(session);
                        sessionList.appendChild(listItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching session list:', error);
                    alert('An error occurred while fetching the session list!');
                });
        }

        // Remove session function
        function removeSession(sessionIdToRemove, listItem) {
            fetch(`${baseUrl}/api/chat/removesession`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer NO_KEY`
                },
                body: JSON.stringify({ sessionId: sessionIdToRemove })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // Remove the session item from the list
                        listItem.remove();
                        // If the removed session is the current session, clear the chat history
                        if (sessionId === sessionIdToRemove) {
                            sessionId = "";
                            document.getElementById('history').innerHTML = '';
                        }
                    } else {
                        alert('Failed to remove the session.');
                    }
                })
                .catch(error => {
                    console.error('Error removing session:', error);
                    alert('An error occurred while removing the session!');
                });
        }

        // Fetch chat history for a given session ID
        function fetchChatHistory(sessionId) {
            fetch(`${baseUrl}/api/chat/history`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer NO_KEY`
                },
                body: JSON.stringify({ sessionId: sessionId })
            })
                .then(response => response.json())
                .then(data => {
                    const historyList = document.getElementById('history');
                    historyList.innerHTML = ''; // Clear existing history
                    data.forEach(messageArray => {
                        const [content, timestamp, role, agent] = messageArray;
                        const historyItem = document.createElement('li');

                        // Include the timestamp
                        const timeDiv = document.createElement('div');
                        timeDiv.classList.add('message-timestamp');
                        timeDiv.textContent = new Date(timestamp).toLocaleString();
                        historyItem.appendChild(timeDiv);

                        if (role === 'user') {
                            historyItem.classList.add('user-message');
                            historyItem.textContent = `You: ${content}`;
                        } else {
                            historyItem.classList.add('ai-message');
                            processResponse(content, 'text', historyItem);
                        }

                        historyList.appendChild(historyItem);
                    });
                    // Scroll to bottom
                    historyList.scrollTop = historyList.scrollHeight;
                })
                .catch(error => {
                    console.error('Error fetching chat history:', error);
                    alert('An error occurred while fetching the chat history!');
                });
        }

        // Process the API response and render accordingly
        function processResponse(responseContent, responseType, responseItem) {
            if (responseType === 'html') {
                // Render the HTML content in an iframe
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('rendered-content');

                const iframe = document.createElement('iframe');
                iframe.srcdoc = responseContent;
                contentDiv.appendChild(iframe);

                responseItem.appendChild(contentDiv);
            } else if (responseType === 'markdown') {
                // Render markdown content
                const converter = new showdown.Converter();
                const html = converter.makeHtml(responseContent);

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('rendered-content');
                contentDiv.innerHTML = html;

                responseItem.appendChild(contentDiv);
            } else if (responseType === 'json' || responseType === 'yaml') {
                // Display as formatted code
                const codeBlock = document.createElement('pre');
                codeBlock.textContent = responseContent;

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('rendered-content');
                contentDiv.appendChild(codeBlock);

                responseItem.appendChild(contentDiv);
            } else if (responseType === 'url') {
                // Display the URL in an iframe
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('rendered-content');

                const iframe = document.createElement('iframe');
                iframe.src = responseContent;
                contentDiv.appendChild(iframe);

                responseItem.appendChild(contentDiv);
            } else if (responseType === 'text') {
                // Check for the specific pattern in the text
                const pattern = /([\s\S]*?)```html\s*([\s\S]*?<\/html>)\s*```([\s\S]*)/i;
                const matches = responseContent.match(pattern);

                if (matches) {
                    const beforeHtml = matches[1];
                    const htmlContent = matches[2];
                    const afterHtml = matches[3];

                    // Create container div
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('rendered-content');

                    // Add the first part
                    if (beforeHtml.trim() !== '') {
                        const beforeDiv = document.createElement('div');
                        beforeDiv.textContent = beforeHtml.trim();
                        contentDiv.appendChild(beforeDiv);
                    }

                    // Render the HTML content in an iframe
                    const iframe = document.createElement('iframe');
                    iframe.srcdoc = htmlContent;
                    contentDiv.appendChild(iframe);

                    // Add the third part
                    if (afterHtml.trim() !== '') {
                        const afterDiv = document.createElement('div');
                        afterDiv.textContent = afterHtml.trim();
                        contentDiv.appendChild(afterDiv);
                    }

                    responseItem.appendChild(contentDiv);
                } else {
                    // No matching pattern, display as plain text
                    responseItem.textContent = `AI: ${responseContent}`;
                }
            } else {
                // Default to plain text
                responseItem.textContent = `AI: ${responseContent}`;
            }
        }

        // Send message function with status updates and spinner
        function sendMessage() {
            const prompt = document.getElementById('prompt-input').value;
            const model = document.getElementById('model-select').value;
            const statusMessage = document.getElementById('status-message');

            if (prompt.trim() === '') {
                alert('Please enter a prompt!');
                return;
            }

            // Show status message with spinner
            statusMessage.style.display = 'flex';
            statusMessage.innerHTML = 'Agent: ' + model + ' is working...<div class="spinner"></div>';

            // Disable input and button
            document.getElementById('prompt-input').disabled = true;
            document.getElementById('send-btn').disabled = true;

            // Add the prompt to the history list
            const historyList = document.getElementById('history');
            const promptItem = document.createElement('li');

            // Include timestamp
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-timestamp');
            timeDiv.textContent = new Date().toLocaleString();
            promptItem.appendChild(timeDiv);

            promptItem.classList.add('user-message');
            promptItem.textContent = `You: ${prompt}`;
            historyList.appendChild(promptItem);

            // Scroll the history to the bottom
            historyList.scrollTop = historyList.scrollHeight;

            // Clear the input box
            document.getElementById('prompt-input').value = '';

            // Send the prompt to the API with SessionID
            fetch(`${baseUrl}/api/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer NO_KEY`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'user', content: prompt }],
                    sessionId: sessionId
                })
            })
                .then(response => response.json())
                .then(data => {
                    // Hide status message
                    statusMessage.style.display = 'none';

                    // Re-enable input and button
                    document.getElementById('prompt-input').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                    document.getElementById('prompt-input').focus();

                    // Get the response from the API
                    sessionId = data.sessionId;

                    // Add the session ID to the session list if it's new
                    if (!document.querySelector(`[data-session-id="${sessionId}"]`)) {
                        const sessionList = document.getElementById('session-list');
                        const session = {
                            id: sessionId,
                            time: new Date().toISOString()
                        };
                        const listItem = createSessionListItem(session);
                        sessionList.appendChild(listItem);
                    }

                    const responseItem = document.createElement('li');

                    // Include timestamp
                    const timeDiv = document.createElement('div');
                    timeDiv.classList.add('message-timestamp');
                    timeDiv.textContent = new Date().toLocaleString();
                    responseItem.appendChild(timeDiv);

                    responseItem.classList.add('ai-message');
                    const responseType = data.object; // 'text', 'html', etc.
                    const responseContent = data.choices[0].message.content;

                    processResponse(responseContent, responseType, responseItem);

                    historyList.appendChild(responseItem);

                    // Scroll the history to the bottom
                    historyList.scrollTop = historyList.scrollHeight;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while fetching the response!');
                    // Hide status message
                    statusMessage.style.display = 'none';

                    // Re-enable input and button
                    document.getElementById('prompt-input').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                });
        }

        // Event listeners
        document.getElementById('send-btn').addEventListener('click', sendMessage);

        document.getElementById('prompt-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initial function calls
        fetchModels();
        fetchSessionList();
    </script>

</body>
</html>
